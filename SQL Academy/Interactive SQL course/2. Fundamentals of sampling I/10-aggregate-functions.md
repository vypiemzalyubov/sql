# Агрегатные функции

В статье об группировках мы обсудили, что при использовании оператора `GROUP BY` мы можем использовать агрегатные функции.
Давайте поговорим о них поглубже.

> Агрегатная функция – это функция, которая выполняет вычисление на наборе значений и возвращает одиночное значение.

## Общая структура запроса с агрегатной функцией

```sql
SELECT [литералы, агрегатные_функции, поля_группировки]
FROM имя_таблицы
GROUP BY поля_группировки;
```

Например, запрос с использованием агрегатной функции `AVG` может выглядеть так:

```sql
SELECT home_type, AVG(price) as avg_price FROM Rooms
GROUP BY home_type
```

| home_type       | avg_price |
| --------------- | --------- |
| Private room    | 89.4286   |
| Entire home/apt | 148.6667  |
| Shared room     | 40        |

## Описание агрегатных функций

| Функция               | Описание                         |
| :-------------------- | :------------------------------- |
| `SUM(поле_таблицы)`   | Возвращает сумму значений        |
| `AVG(поле_таблицы)`   | Возвращает среднее значение      |
| `COUNT(поле_таблицы)` | Возвращает количество записей    |
| `MIN(поле_таблицы)`   | Возвращает минимальное значение  |
| `MAX(поле_таблицы)`   | Возвращает максимальное значение |

> Агрегатные функции применяются для значений, не равных `NULL`. Исключением является функция `COUNT(*)`.

## Примеры

<ERD databaseName="Airbnb" />

- Найдём количество каждого вида жилья и отсортируем полученный список по убыванию:

  ```sql
  SELECT home_type, COUNT(*) as amount FROM Rooms
  GROUP BY home_type
  ORDER BY amount DESC
  ```

  | home_type       | amount |
  | --------------- | ------ |
  | Private room    | 28     |
  | Entire home/apt | 21     |
  | Shared room     | 1      |

- Для каждого жилого помещения найдём самую позднюю дату выезда (поле `end_date`)

  ```sql
  SELECT room_id, MAX(end_date) AS last_end_date FROM Reservations
  GROUP BY room_id
  ```

  | room_id | last_end_date        |
  | ------- | -------------------- |
  | 1       | 2019-02-04T12:00:00Z |
  | 2       | 2020-03-23T09:00:00Z |
  | 13      | 2020-04-21T10:00:00Z |
  | 16      | 2019-06-24T10:00:00Z |
  | 21      | 2020-02-29T10:00:00Z |
  | 19      | 2020-05-02T10:00:00Z |
  | 8       | 2020-01-21T12:00:00Z |
  | 7       | 2019-09-17T10:00:00Z |
  | 5       | 2020-05-15T10:00:00Z |
  | 50      | 2019-11-25T11:00:00Z |
  | 49      | 2020-06-11T10:00:00Z |
  | 48      | 2019-11-10T10:00:00Z |
  | 32      | 2020-01-18T13:00:00Z |
  | 17      | 2019-11-05T09:00:00Z |
  | 25      | 2020-04-22T09:00:00Z |
  | 14      | 2020-02-12T10:00:00Z |
  | 39      | 2019-12-09T10:00:00Z |
  | 38      | 2020-03-23T10:00:00Z |
